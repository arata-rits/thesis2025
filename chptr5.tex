%/**********************************************************************/
%		第5章：
%/**********************************************************************/
\chapter{カラーQRコードを用いたAIイラストの生成}
\label{lbl_chptr2}

本章では，イラストに見えるQRコード画像について触れ，その技術の根幹となるイラスト生成AIの原理について述べる．また，カラーQRコードを使用した類似画像の生成手法について検討を行った．

%/**********************************************************************/
%		イントロの章
%/**********************************************************************/

\section{イラストに見えるQRコード}

近年，イラスト生成AI技術が急速に発展している．FORTUNE BUSINESS INSIGHTSの生成AI市場分析\cite{AI_market}によると，世界の生成AI市場規模は2023年に438億7,000万米ドルと評価されていると述べている．また，この市場規模は年々増加し，年平均成長率は39.6\%にまでのぼると推定している(図\ref{fig:Ai_market_size}). 


\footnotetext{Fortune Business Insights | 生成AI市場規模、シェア＆業界分析、モデル別（生成官民ネットワークまたはGANSおよび変圧器ベースのモデル）、業界対アプリケーション、地域予測、2024-2032別 |SS より引用}


\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/Ai_market_size.png}
	\caption{生成AIの市場規模予測}
	\label{fig:Ai_market_size}
\end{figure}

一方，このデータは生成AI全般を含めたものであり，イラスト生成AIに限ったものではない．しかしながら，生成AIの発展に伴い，イラスト生成AIの技術進歩，また，社会への普及や，その市場規模も高まっていくと予測される．特にイラスト生成AIの活用例としてQRコードを入力画像として取り込むことで，イラストのように見えるが，実際に機能する二次元コードの生成が行われている．このようなQRコードはアートQRコードと呼ばれている．その例が，図\ref{fig:illust_QR_example1}，及び\ref{fig:illust_QR_example2}である．実際にQRコードリーダーでこれらの読み取りを行うと，それぞれ，\url{(https://qrbtf.com)}と，\url{(https://note.com/st_ai)}が得られる．

\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\linewidth]{pics/illust_QR_example1.png}
	\caption{アートQRコードの例1}
	\label{fig:illust_QR_example1}
\end{figure}


\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/illust_QR_example2.png}
	\caption{アートQRコードの例2}
	\label{fig:illust_QR_example2}
\end{figure}

ここで，comfyUIを使用してアートQRコードを生成するための流れについて述べる．
始めに，アートQRコードにするための元画像となるQRコードを用意する．次にQRコードのセルに対して調整を行い，QRコードセルの結びつきを弱める．最後に，イラスト生成AIに対して入力画像として与える(図\ref{fig:artQR_flow})．\cite{artQR_1}によると，特に，QRコードの調整処理が重要であるとしている．図\ref{fig:artQR_flow}に記載のアートＱＲコードは，Anthony Fu's QR Toolkit\footnote{https://qrcode.antfu.me/\#verify}を使用して，QRコードの調整を行った．Anthony Fu's QR Toolkitはweb上で公開されているQRコード生成サイトであり，通常のQRコード生成に加え，誤り訂正レベルの指定や，ピクセルスタイルの変更，色の指定等を行うことができる(図\ref{fig:QR_fix})．また，アートQRコード生成時に使用したプロンプトを\ref{tab:prompt}に示す．

\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/artQR_flow.png}
	\caption{アートQRコード生成の流れ}
	\label{fig:artQR_flow}
\end{figure}


\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/QR_fix.png}
	\caption{QRrコードの調整に使用したQRコード生成サイト}
	\label{fig:QR_fix}
\end{figure}


\begin{table}[]
	\centering
	\setlength{\tabcolsep}{10pt}
	\renewcommand{\arraystretch}{1.4}
	\caption{使用したプロンプト}
	\label{tab:prompt}
	\begin{tabular}{|l|l|}
	\hline
	positive prompt                                                                                                                                                                                                                                                                                                                                                                                 & negative prompt                                                                                                                                                          \\ \hline
	\begin{tabular}[c]{@{}l@{}}(1girl:1.3), solo, long\_hair, breasts, looking\_at\_viewer,\\  blush, black\_hair, dress, bow, ribbon, closed\_mouth, \\ cleavage, bare\_shoulders, medium\_breasts, standing, \\ purple\_eyes, hair\_ribbon, short\_sleeves, frills, hairband, \\ black\_dress, wrist\_cuffs, feet\_out\_of\_frame, white\_bow, \\ white\_ribbon, (black\_ribbon:1.3)\end{tabular} & \begin{tabular}[c]{@{}l@{}}embedding:EasyNegative, \\ embedding:bad\_prompt\_version2-neg, \\ embedding:verybadimagenegative\_v1.3, \\ (Multiple girls:1.3)\end{tabular} \\ \hline
    \end{tabular}
\end{table}



\section{カラーQRコード入力によるアートQRコード生成の利点}
現在のアートQRコード生成は，入力画像をモノクロのQRコードとするものにとどまっている．本節では，入力画像をカラーQRコードに拡張することを目標として得られる利点について述べる．

カラーQRコードに対応したカラーアートQRコード生成について2種類の方法が挙げられる．


\begin{enumerate}[label=\Alph*.]
	\item 3種類の重ね合わせを行ったカラーQRコードを入力画像に使用する方法(図\ref{fig:color_art_qr_A})
	\item 単色カラーのQRコードを入力画像として使用し，読み取りにカラーQRコード検出のシステムを使用する方法(図\ref{fig:color_art_qr_B})
\end{enumerate}

\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/color_art_qr_A.png}
	\caption{アートQRコード生成手法A}
	\label{fig:color_art_qr_A}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/color_art_qr_B.png}
	\caption{アートQRコード生成手法B}
	\label{fig:color_art_qr_B}
\end{figure}

Aの方法による利点として，情報量の増加が挙げられる．また，従来のアートQRコードと比較して，よりカラフルな画像の生成が行われると考えられる．

Bの方法による利点として，よりイラストに近い形での画像生成が可能になることが挙げられる．
例として，緑色単色QＲコードを使用して，カラーアートQRコードを生成する事を考える．この時．デコード時に緑色が抽出されることから，画素値でいう赤(R)と青(B)の値は任意の値をとれる．また閾値を使用して色の抽出を行う場合，QRコードの背景となる部分(情報のないところ)では，赤(R)と青(B)の値は任意の値，緑(G)は128以下の値で任意の値をとることができる(図\ref{fig:illust_qr_merit})．




\begin{figure}[H]
	\centering
	\includegraphics[width=1.2\linewidth]{pics/illust_qr_merit.png}
	\caption{カラーアートQRコードの仕様の例}
	\label{fig:illust_qr_merit}
\end{figure}





\section{イラスト生成AIの原理}
代表的な生成モデルであるGAN (敵対的生成ネットワーク)とDiffusion model (潜在拡散モデル)について述べる．


\subsection{GAN}

GANとは，Generative Adversarial Networkの頭文字である\cite{GAN}．GANでは，生成モデル(Generator)と識別モデル(Discriminator)という2つのニューラルネットワークが互いに競い合いながら学習を行う構造をとる．生成モデルが実在する画像データに近い偽画像を生成し，一方で識別モデルは入力された画像が実が増加生成が増加を判別する役割を担う．

学習過程では，生成モデルは識別モデルを欺くような画像を生成しようとし，識別モデルはその判別精度を高めようとする．このような敵対的学習を繰り返すことで，より高品質な画像を生成することを目指すモデルである．GANによるイラスト生成の仕組みを表したものが図\ref{fig:GAN_image}である．

\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/GAN_image.png}
	\caption[GANによる生成のイメージ]{GANによる生成のイメージ\protect\footnotemark}
	\label{fig:GAN_image}
\end{figure}

\footnotetext{Financial Engineering Group|敵対的生成ネットワーク\\|\url{https://www.feg.co.jp/analysis_tech/gan/}より引用}

\subsection{潜在拡散モデル}
Diffusion（拡散モデル）は、近年の画像生成AIにおいて主流となっている生成モデルである\cite{diffusion_model}。拡散モデルは、画像に徐々にノイズを加えていく順拡散過程と、そのノイズを段階的に除去する逆拡散過程を学習することで、画像生成を実現する仕組みを特徴とする。学習段階では、実画像に対してランダムノイズを加え、そのノイズ成分を推定・除去する方法をモデルが学習する。

生成段階では、完全なノイズ画像を初期状態とし、学習済みモデルによってノイズを少しずつ取り除くことで、最終的に意味のある鮮明な画像を生成する。この過程は、ぼやけた画像に段階的に情報を付加し、徐々に明瞭な画像を完成させる作業に例えられる。こうした逐次的かつ確率的な生成プロセスにより、拡散モデルは高い表現力と安定した学習特性を実現している。

また、GANと比較して学習が安定しやすく、モード崩壊が起こりにくい点も拡散モデルの大きな利点である。この特性から、Stable DiffusionやDALL·Eといった多くの先進的な画像生成AIに採用されており、高品質かつ多様性のある画像生成が可能となっている。本研究で使用しているイラスト生成ツールであるComfyUIは，Stable Diffusionを基盤とした画像生成ツールである。ここで，Stable Diffusionは，潜在拡散モデルに基づく生成手法である.潜在拡散モデルによるイラスト生成の仕組みを表したものが図\ref{fig:diffusion_model_image}である．


\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/diffusion_model_image.png}
	\caption[GANによる生成のイメージ]{潜在拡散モデルによる生成のイメージ\protect\footnotemark}
	\label{fig:diffusion_model_image}
\end{figure}

\footnotetext{@ps010　(cyumizou)　in　Supership株式会社|図で見てわかる！画像生成AI「Stable\\ Diffusion」の仕組み\url{https://qiita.com/ps010/items/ea4e8ddeff4de62d1ab1}より引用}

\section{使用したソフトとモデル}
カラーQRコードを使用したイラスト生成を行うため，comyUI\footnote{https://www.comfy.org/}を使用した．ここで，comfyUIとは，イラスト生成AIを独自にカスタマイズできるツールの一種である．本ツールでは，ノードと呼ばれる素子同士をつなぎ合わせることで，仕様モデルの選択や，モデルの強度の変更などの画像生成におけるカスタマイズをノーコードで行うことができる．本ツールの使用にあたって，一般的なQRコードをイラスト改変するワークフローが公開されていたwebサイト\cite{artQR_1}\cite{artQR_2}を参考にした．comfyUIの操作画面が図\ref{fig:comfyUI}である．


%\begin{figure}[H]
%	\centering
%	\includegraphics[width=1.0\linewidth]{pics/comfyUI.png}
%	\caption{comfyUIの操作画面}
%	\label{fig:comfyUI}
%\end{figure}

\begin{sidewaysfigure}
	\centering
	\includegraphics[width=\textheight]{pics/comfyUI.png}
	\caption{comfyUIの操作画面}
	\label{fig:comfyUI}
\end{sidewaysfigure}



ここでcomfyUIで使用したノードについて述べる．

\subsection{VAE　(variational auto encoder)}
VAEとは画像データの圧縮時の特徴を抽出する方法を決定しているモデルである．従って出力画像の品質に大きく影響を及ぼす．本実験では参考サイトのワークフローに習い，NoCrypt/blessed\_vaeを使用した．




\subsection{チェックポイント(ckpt)}
チェックポイントは出力画像の画風に影響を与える．Stable diffusionの学習過程で作成された画像の特徴を保存したファイルである．そのため，他のモデルに対して数GBと大きな容量をもつファイルとなる．本実験では参考サイトのワークフローに習い，primemix\_v21を使用した．



\subsection{controlnet}
画像生成の構図や形状を自在にコントロールできる拡張機能となる．画像生成の過程に割り込むことで，出力画像に大きく影響を与える．QRコードを用いたイラスト改変技術に大きく関わるノードである．本実験で使用したcontrolnetモデルについては5.5節のとおりである．

\subsection{Kサンプラー}
出力画像の仕上がりに影響を与える．無数にあるノイズの中から少しずつ画像を作っていく工程を担当するノードである．シード値の変更や，ステップ数の変更が可能である．


\subsection{LoRA}
Low-Rank-Adaptationの頭文字であり，少ないリソースで効率的に学習ができる手法である．画風の調整や，人物やキャラクターの指定など，多岐にわたる調整を可能とするようなモデルが複数存在する．ただし，生成過程に割り込むcontrolnetに比べて，出力画像に与える影響は比較的少ないとされる．


\section{実験内容}
本実験の目的は，従来，モノクロのQRコードを入力画像として作成するアートQRコードの生成に対して，入力画像にカラーQRコードを使用し，QRコードの可読性がある生成AIイラストを得ることである．従って，従来のアートQRコードのワークフローをベースとして，使用するcontrolnetモデルを追加する改変を加えた．

本実験で使用したcontrolnetモデルを以下に示す．\\

・monster-labs/control\_v1p\_sd15\_qrcode\_monster (以下，qrcode\_monster)

・latentcat/control\_v1p\_sd15\_brightness (以下，brightness)

・TencentARC/T2Iadapter\_color\_sd14v1 (以下，T2Iadapter\_color)


従来のワークフローではqrcode\_monsterとbrightnessの二つを使用していた．しかし，入力画像をカラーQRコードとする場合には，入力画像の色の位置を出力画像に反映する必要がある．従って，T2Idapter\_colorを新しく採用した．

生成には，各controlnetの強度を変更するパラメータとした．実験の内容が以下の2つである．

・各controlnetを単体で使用し，強度を変えて生成を行う

・3つのcontrolnetを併用し，強度を変えて生成を行う

1つ目の実験では，強度を，0.5, 1.0, 1.5と変更して生成を行った．

２つ目の実験では，controlnetの強度に対して，(brightness, T2Iadapter\_color, qr\_monster) = (0.3, 0.9, 0.3)を基準として，それぞれパラメータを変えて生成を行った．このパラメータを基準として設定した理由は2つある．1つ目は，入力画像が持つ色の情報を出力画像に強く反映させるためである．従って，T2Iadapter\_colorの強度を高く設定している．2つ目は，controlnet同士の干渉を防ぐためである．controlnetの強度を極端に高い値に設定すると，モデル同士の干渉が発生してしまい，狙った生成結果が得られないケースが存在する．従って，使用するcontrolnetの強度の合計が1.5となるように基準を設定した．


\section{実験結果}


\subsection{各controlnetによる出力画像への影響}
はじめに，cotrolnetを単体で使用したときの出力結果に与える影響を比較した．ポジティブプロンプト，ネガティブプロンプトへの入力を共に空白(" ")として生成を行った．入力画像として使用した画像が図\ref{fig:input_image}である．

latentcat/control\_v1p\_sd15\_brightnessを使用して画像生成を行った結果が図\ref{fig:str_bightness}である．
次に，monster-labs/control\_v1p\_sd15\_qrcode\_monsterを使用した画像生成を行った．本モデルには，新旧2つのバージョンが存在したため，それぞれのバージョンを用いた生成を行った.　生成の結果が図\ref{fig:str_qr_monster_v1}，及び\ref{fig:str_qr_monster_v2}である．さらに，TencentARC/t2iadapter\_color\_sd14v1を使用した画像生成を行った．生成の結果が図\ref{fig:str_T2Iadapter_color}である．


\begin{figure}[H]
	\centering
	\includegraphics[width=0.5\linewidth]{pics/input_image.png}
	\caption{画像生成に使用した入力画像}
	\label{fig:input_image}
\end{figure}


\begin{figure}[H]
	\centering
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/st05.png}
		\caption{強度0.5}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/st1_0.png}
		\caption{強度1.0}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/st1_5.png}
		\caption{強度1.5}
	\end{subfigure}
	\caption{brightnessの強度による比較}
	\label{fig:str_bightness}
\end{figure}
\vspace{1\baselineskip}


\begin{figure}[H]
	\centering
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/qr_v1_0_5.png}
		\caption{強度0.5}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/qr_v1_1_0.png}
		\caption{強度1.0}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/qr_v1_1_5.png}
		\caption{強度1.5}
	\end{subfigure}
	\caption{qrcode\_monster\_v1の強度による比較}
	\label{fig:str_qr_monster_v1}
\end{figure}
\vspace{1\baselineskip}


\begin{figure}[H]
	\centering
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/qr_v2_0_5.png}
		\caption{強度0.5}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/qr_v2_1_0.png}
		\caption{強度1.0}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/qr_v2_1_5.png}
		\caption{強度1.5}
	\end{subfigure}
	\caption{qrcode\_monster\_v2の強度による比較}
	\label{fig:str_qr_monster_v2}
\end{figure}
\vspace{1\baselineskip}



\begin{figure}[H]
	\centering
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/T2Icolor_0_5.png}
		\caption{強度0.5}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/T2Icolor_1_0.png}
		\caption{強度1.0}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\centering
		\includegraphics[width=\linewidth]{pics/T2Icolor_1_5.png}
		\caption{強度1.5}
	\end{subfigure}
	\caption{T2Iadapter\_colorの強度による比較}
	\label{fig:str_T2Iadapter_color}
\end{figure}
\vspace{1\baselineskip}


\subsection{3種類のcontrolnetを使用した画像生成}

画像生成の結果が図\ref{fig:result_1}，及び\ref{fig:result_1}である．
出力結果として，入力画像に対する色の再現度が低く，今回実験したパラメータでは可読性のあるカラーアートQRコードを生成することはできなかった．

\begin{figure}[H]
	\centering
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_03_09_03.png}
	\caption{(0.3, 0.9, 0.3)}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_03_07_03.png}
	\caption{(0.3, 0.7, 0.3)}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_03_11_03.png}
	\caption{(0.3, 1.1, 0.3)}
	\end{subfigure}
	\vspace{5mm}
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_05_09_05.png}
	\caption{(0.5, 0.9, 0.5)}
	\end{subfigure}
	\hfill	
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_07_09_07.png}
	\caption{(0.7, 0.9, 0.7)}
	\end{subfigure}
	\hfill	
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_01_09_03.png}
	\caption{(0.1, 0.9, 0.3)}
	\end{subfigure}
	\caption{3種類のcontrolnetを使用した生成結果(1)}
	\label{fig:result_1}
\end{figure}
	
	
\begin{figure}[H]
	\ContinuedFloat
	\centering
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_03_09_01.png}
	\caption{(0.3, 0.9, 0.1)}
	\end{subfigure}
	\hfill	
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_06_06_03.png}
	\caption{(0.6, 0.6, 0.3)}
	\end{subfigure}	
	\hfill
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_03_06_06.png}
	\caption{(0.3, 0.6, 0.6)}
	\end{subfigure}
	
	\vspace{5mm}
	
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_00_09_03.png}
	\caption{(0.0, 0.9, 0.3)}
	\end{subfigure}	
	\hspace{5mm}
	\begin{subfigure}{0.3\linewidth}
	\centering
	\includegraphics[width=\linewidth]{pics/temp_03_09_00.png}
	\caption{(0.3, 0.9, 0.0)}
	\end{subfigure}
	\caption{3種類のcontrolnetを使用した生成結果(2)}
	\label{fig:result_2}
\end{figure}
\vspace{1\baselineskip}





\section{考察}

本実験では．プロンプトを空白として画像生成を行ったが，アニメ風のキャラクターのような出力画像が得られた．これは，生成に使用したチェックポイントの影響によるものと考えられる．生成に使用したチェックポイントであるprimemix\_v21は，人物表現に優れたモデルであり，学習に使用されたアニメイラストの影響により実験のような結果が得られたと考えられる．また，図\ref{fig:str_bightness}の結果から，brightnessは入力画像の構造を色濃く出力に影響させるモデルであることが分かった．更に．TencentARC/t2iadapter\_color\_sd14v1は入力画像に対する出力への影響が比較的少なく，生成画像からQRコードが取得できる色の再現は見られなかった．


3種類のcontrolnetを使用した実験に関して，図\ref{fig:result_1}，及び\ref{fig:result_1}の(f), (j)にみられるように，brightnessの値が低いと，入力画像の構造が反映されず，ファインダパターン領域が消失される事が確認できた．また，(a), (b), (c)では，比較的同様の生成結果が得られた．
