%/**********************************************************************/
%		第4章：
%/**********************************************************************/
\chapter{カラーQRコードエンコード/デコードシステムの開発}
\label{lbl_chptr2}

本章では，カラーQRコードの読み取りシステム開発について述べる．
はじめに，3.1，及び3.2節で，エンコード方法とデコード方法を述べ．3.3節で読み取りアプリの開発について述べる．


%/**********************************************************************/
%		イントロの章
%/**********************************************************************/

\section{研究目的}
近年，スマートフォンに搭載されるカメラの解像度・ダイナミックレンジ・色再現性は著しく向上している.
表\ref{tab:iPhone_camera}は，apple社製iPhoneの歴代発売年と機種，搭載カメラの画素数をまとめたものである．




\begin{table}[H]
	\centering
	\caption[歴代iPhone機種に搭載されたカメラの画素数比較]{歴代iPhone機種に搭載されたカメラの画素数比較\protect\footnotemark}
	\label{tab:iPhone_camera}
	\begin{tabular}{|l|l|l|}
		\hline
		発売年  & \multicolumn{1}{c|}{機種} & 画素数    \\ \hline
		2025 & iPhone 17               & 4,800万 \\ \hline
		2024 & iPhone 16               & 4,800万 \\ \hline
		2023 & iPhone 15               & 4,800万 \\ \hline
		2022 & iPhone 14               & 1,200万 \\ \hline
		2021 & iPhone 13               & 1,200万 \\ \hline
		2020 & iPhone 12               & 1,200万 \\ \hline
		2019 & iPhone 11               & 1,200万 \\ \hline
		2017 & iPhone X                & 1,200万 \\ \hline
		2017 & iPhone 8                & 1,200万 \\ \hline
		2016 & iPhone 7                & 1,200万 \\ \hline
		2014 & iPhone 6                & 800万   \\ \hline
		2012 & iPhone 5                & 800万   \\ \hline
		2010 & iPhone 4                & 500万   \\ \hline
		2008 & iPhone 3G               & 200万   \\ \hline
	\end{tabular}
\end{table}

\footnotetext{SoftBank|よくあるご質問(FAQ)>［iPhone］カメラの画素数はどのくらいですか？|\url{https://www.softbank.jp/support/faq/view/11825}　及び，apple|iPhoneのモデルを識別する|\url{https://support.apple.com/ja-jp/108044}より引用}

%https://www.softbank.jp/support/faq/view/11825

一方で，カラーQRコードに関する先行研究の多くは約10年前に行われたものであり，当時のカメラ性能や撮影環境を前提として評価がなされている．また，それらの研究の多くは紙媒体に印刷されたQRコードを対象とした評価であり，現在広く普及していデジタルサイネージ等のディスプレイ表示を対象とした検証は十分に行われていない．

しかし現代においては，広告・案内表示・店舗情報提示などの用途で，ディスプレイ上にQRコードを表示し，スマートフォンで読み取る利用形態が一般的になっている.このような表示環境では，印刷媒体とは異なり，発光色・画素構造・表示輝度などの特性が読み取りに影響を与えると考えられる. そこで本研究では，RGBの重ね合わせによるカラーQRコードに対して，エンコード/デコードを行うシステムを構築し，その評価として，カラーQRコードとモノクロQRコードの距離に応じた検出率の比較実験を行った．さらに，システムにおける撮影画像に対する後処理の有効性を調べた．


\section{エンコード方法}
カラーQRコードの読み取りシステムに使用するエンコード方法を示す．はじめに，任意の文字列が一般のQRコード生成して，仕様によりモノクロのQRコードが作成される．同様に，3つの文字列をもとに3種類のモノクロQRコードを用意する．この3種類のモノクロQRコードを単色のカラー画像に変換する．本システムでは，赤(R), 緑(G),青(B)の三色に変換している．その後，3種類の単色カラー画像を加法混色(図\ref{fig:kahokonsyoku})により重ね合わせることで，カラーQRコードが作成される(図\ref{fig:colorQR_encode}).　カラーQRコードは，赤，緑，青色の各色が画素値として0か255のどちらかの値をとる．つまり，$2 \times 2 \times 2$ = $2^3$ = 8 通りの色で表される．ここで8通りの色とは，白，黒，赤，緑，青，シアン，マゼンタ，イエローの8種類となる．画素値を(R, G, B)で表記すると，各色はそれぞれ，白(255, 255, 255)，黒(0, 0, 0)，赤(255, 0, 0)，緑(0, 255, 0)，青(0, 0, 255)，シアン(0, 255, 255)，マゼンタ(255, 0, 255)，イエロー(255, 255, 0)である．これらの仕様に基づき，カラーQRコードをエンコードするプログラムを作成した(付録\ref{app:encode})．



\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{pics/kahokonsyoku.png}
	\caption{加法混色}
	\label{fig:kahokonsyoku}
\end{figure}


\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/colorQR_encode.png}
	\caption{カラーQRコードのエンコード方法}
	\label{fig:colorQR_encode}
\end{figure}


\section{色空間について}
コンピュータ上で画像は，色の数値の組み合わせによる色空間により表現されている．最も主要な色空間としてRGB色空間\cite{RGB}が挙げられる．RGB色空間ではR　(赤), G　(緑), B　(青)に0～255までの値が格納され，その値の組み合わせにより色が表現される．例として(R, G, B) = (255, 165, 0)のとき．橙色となり，(R, G, B) = (255, 165, 0)のとき，灰色が表現される(図\ref{fig:rgb_example})．
また，別の色空間としてHSV色空間が挙げられる．HSV色空間\cite{HSV}とは，色を色相　(H)，彩度　(S)，明度　(V)の3成分で表現する色空間のことである ．HSVとは，Hue(色相)，Saturation(彩度)，Value(明度)の頭文字に由来している．HSV色空間を用いた色の表現例が図\ref{fig:HSV_image}である．
RGＢ色空間がデバイス依存の色表現であるのに対して，HSV色空間は人間の色知覚に近い直感的な表現を目的として提案された．HSV色空間を使用する利点として，より正確な色抽出が可能な点が挙げられる．HSV色空間において，色の種類はH成分によって決定されるため，照明等による明るさの影響を抑えたロバスト性の高い色抽出が可能になる．従って，本研究で使用するプログラムでは，取得した撮影画像を，HSV色空間に変換した後に，色抽出を行う手法を採用する．


\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/rgb_example.png}
	\caption{RGB色空間における色の表現例}
	\label{fig:rgb_example}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/HSV_image.png}
	\caption[HSV色空間での色の表現方法]{HSV色空間での色の表現方法\protect\footnotemark}
	\label{fig:HSV_image}
\end{figure}


\footnotetext{321web|色の三属性「色相」「明度」「彩度」とは？【HSB/HSV】(https://321web.link/color-attribute/)より引用}



\section{デコード方法}
図\ref{fig:colorQR_decode}は，カラーQRコードの読み取りシステムにおけるデコード方法を示したものある．はじめに，カラーQRコードに対して，画像処理による色の抽出を行う．デコードのフローチャートが図\ref{fig:decode_flow}である．


\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/colorQR_decode.png}
	\caption{カラーQRコードのデコード方法}
	\label{fig:colorQR_decode}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.5\linewidth]{pics/decode_flow.png}
	\caption{デコード時のフローチャート}
	\label{fig:decode_flow}
\end{figure}


ここで，膨張(dilation)処理と収縮(erosion)処理について詳しく述べる．
膨張処理とは，画像中の指定個所を太くする処理のことである．例えば，白色の箇所に対して膨張処理を行う場合，対象とする構造要素(カーネル)に対して．周囲も白色に塗りつぶすような処理が行われる．膨張処理の処理イメージが図\ref{fig:dilation}である．

\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/dilation.png}
	\caption{膨張処理のイメージ}
	\label{fig:dilation}
\end{figure}

次に，収縮処理とは，画像中の指定個所を細くするような処理のことである．例えば，白色の箇所に対して収縮処理を行う場合，対象とする構造要素(カーネル)に対して．周囲の黒い画素に浸食されるような処理が行われる．収縮処理の処理イメージが図\ref{fig:erosion}である．

\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/erosion.png}
	\caption{収縮処理のイメージ}
	\label{fig:erosion}
\end{figure}

このように画像の形状を整えるような処理を総称してモルフォロジー処理と呼ばれる．
また，収縮の後に膨張を行う処理をオープニング(opening)処理，膨張の後に収縮を行う処理をクロージング(closing)処理と呼ぶ．本システムでは，ノイズ除去を目的として，クロージング処理を適用している．

また，色の抽出処理に関しては，OpenCVによるマスクの生成を使用している．図\ref{fig:color_extract_program}は，カラーQRコードの読み取りアプリの一部である．ここでは，赤色に対する色の抽出処理を行っている．ここで，取得された画像は，cv2.cvtColorにより，RGB画像から，HSV画像に変換される．次に，np.arrayにより，各色の範囲が定義される．赤色が抽出される範囲には黄色や，マゼンタも含まれるため，それぞれ定義がなされる．さらに，cv2.inRangeにより，抽出したパーツ同士のマスクが生成される．最後に,cv2.bitwise\_orを用いて．別々に抽出した白，赤，黄，マゼンタの範囲が結合される．ここで定義された範囲を黒に塗りつぶし，他の領域を白に塗りつぶすことで，カラーＱＲコードから個別のＱＲコードが抽出される．


\begin{figure}[H]
	\centering
	\includegraphics[width=1.0\linewidth]{pics/color_extract_program.png}
	\caption{赤色に対する色の抽出処理}
	\label{fig:color_extract_program}
\end{figure}


\section{読み取りアプリの開発}
前述のエンコード，デコード方法を使用して，読み取りアプリの開発を行った．開発にあたりPython製の軽量WebフレームワークであるFlaskを使用し，画像保存時のデータベースとしては，SQLiteを使用した．また，バックエンド側の画像処理には，OpenCVを使用した．さらに，QRコードの認識には，ZBarをPythonから利用するライブラリであるpyzbarを使用した．ここで，Zbarとは，バーコードやQRコードなどの2次元コードを読み取る為の, フリーかつオープンソースで利用できるライブラリのことである．


開発したアプリにスマートフォン端末からアクセスした際の表示画面が図\ref{fig:flask_toppage}である．本システムの実装はノートPCにローカルのサーバーを立てることで実装を行った．従って，スマートフォンをローカルサーバーと同一のWi-Fiに接続するなど，同一のネットワーク内のみで動作検証が可能である．ユーザーは"ファイルを選択"ボタンからカメラによる画像撮影が可能である．次に，画面中央の各色の抽出ボタンを選択可能である．各ボタンを押すことで，抽出する色の種類を選択することが可能であり，バックエンド側での画像処理が実行される．QRコードが検出された際には，検出先のURLへ遷移される．また，QRコード不検出の場合には，画面中央にポップアップが表示される(図\ref{fig:flask_no_detected})．

\setlength{\fboxsep}{0pt}   % 画像と枠の隙間
\setlength{\fboxrule}{1pt} % 枠線の太さ

\begin{figure}[H]
	\centering
	\fbox{\includegraphics[width=0.5\linewidth]{pics/flask_toppage.png}}
	\caption{読み取りアプリのweb画面表示}
	\label{fig:flask_toppage}
\end{figure}

\begin{figure}[H]
	\centering
	\fbox{\includegraphics[width=0.5\linewidth]{pics/flask_no_detected.png}}
	\caption{QRコード不検出時のweb画面表示}
	\label{fig:flask_no_detected}
\end{figure}